<!DOCTYPE html>
<html lang="en"
      th:replace="~{fragments/main-layout :: main-layout(~{::title}, ~{::.content})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Shopping Cart</title>
</head>
<body>
<div class="content">
    <style>
        .no-spinners::-webkit-inner-spin-button,
        .no-spinners::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-spinners {
            -moz-appearance: textfield;
        }
    </style>

    <h2>Your Shopping Cart</h2>
 
    <div class="alert alert-danger" role="alert" th:if="${errorMessage}"
         th:text="${errorMessage}"></div>

    <div th:if="${cart == null || cart.items.isEmpty()}">
        <p class="lead">Your cart is empty.</p>
        <a class="btn btn-primary" th:href="@{/products/list}">
            Continue Shopping</a>
    </div>

    <div th:if="${cart != null && !cart.items.isEmpty()}">
        <div class="table-responsive">
            <table class="table table-hover">
                <table class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>Product</th>
                        <th class="text-end">Price</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-end">Total</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item : ${cart.items}">
                        <td th:text="${item.product.name}">Product Name</td>
                        <td class="text-end"
                            th:text="${#numbers.formatCurrency(item.product.price == null ? 0 : item.product.price)}"></td>
                        <td class="text-center" style="min-width: 160px;">
                            <form class="d-inline" method="post"
                                  th:action="@{/cart/update}">
                                <input th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"
                                       type="hidden"/>
                                <input name="_method" type="hidden" value="put">
                                <input name="productId"
                                       th:value="${item.product.id}"
                                       type="hidden"/>
                                <div class="input-group input-group-sm justify-content-center">
                                    <button class="btn btn-outline-secondary"
                                            onclick="var input = this.nextElementSibling; input.stepDown(); input.dispatchEvent(new Event('change'));"
                                            type="button">
                                        -
                                    </button>

                                    <input class="form-control text-center stock-quantity-input no-spinners"
                                           min="1" name="quantity"
                                           style="max-width: 60px;"
                                           th:max="${item.product.stockQuantity()}"
                                           th:value="${item.product.inCartQuantity()}"
                                           type="number"/>

                                    <button class="btn btn-outline-secondary"
                                            onclick="var input = this.previousElementSibling; input.stepUp(); input.dispatchEvent(new Event('change'));"
                                            type="button">
                                        +
                                    </button>
                                </div>
                            </form>
                        </td>
                        <td class="text-end"
                            th:text="${#numbers.formatCurrency(item.product.inCartQuantity() * item.product.price())}"></td>

                        <td class="text-center">
                            <form method="post" th:action="@{/cart/remove}">
                                <input th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"
                                       type="hidden"/>
                                <input name="_method" type="hidden"
                                       value="delete"/>
                                <input name="productId"
                                       th:value="${item.product.id}"
                                       type="hidden"/>
                                <button class="btn btn-danger btn-sm"
                                        title="Remove item"
                                        type="submit">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>

                    <tfoot>
                    <tr>
                        <td class="text-end fw-bold" colspan="4">Grand Total
                        </td>
                        <td class="text-end fw-bold"
                            th:text="${#numbers.formatCurrency(cart.totalAmount)}"></td>
                    </tr>
                    </tfoot>
                </table>

                <div class="d-flex flex-wrap justify-content-between mt-4 gap-2">
                    <a class="btn btn-secondary" th:href="@{/products/list}">Continue
                        Shopping</a>
                    <a class="btn btn-success btn-lg"
                       th:href="@{/orders/shipping-details}">
                        <i class="bi bi-truck"></i>
                        Delivery and payment
                    </a>
                </div>
            </table>
        </div>
    </div>

    <!-- Quantity validation -->
    <div th:replace="~{fragments/stock-quantity-form :: stock-quantity-script}"></div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            let debounceTimer;
            const allControls = document.querySelectorAll('.stock-quantity-input, .input-group button');

            document.querySelectorAll('.stock-quantity-input').forEach(input => {
                const form = input.closest('form');
                input.addEventListener('change', function (e) {
                    const currentForm = e.target.closest('form');
                    clearTimeout(debounceTimer);

                    allControls.forEach(control => {
                        control.disabled = control.closest('form') !== currentForm;
                    });

                    debounceTimer = setTimeout(() => {
                        allControls.forEach(control => {
                            if (control.tagName.toLowerCase() === 'input') {
                                control.readOnly = true;
                            } else {
                                control.disabled = true;
                            }
                        });
                        form.submit();
                    }, 500);
                });
            });
        });
        /*]]>*/
    </script>
</div>
</body>
</html>
