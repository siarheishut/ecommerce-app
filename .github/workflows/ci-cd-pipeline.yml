name: E-commerce CI/CD

on:
  push:
    branches:
      - "main"
      - "dev"
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:

jobs:
  build:
    name: Build, Test and Push Image
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      packages: 'write'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Debug - Print GitHub Ref
        run: echo "The Git ref for this job is ${{ github.ref }}"

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker europe-central2-docker.pkg.dev

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: 'maven'

      - name: Make mvnw executable
        run: chmod +x ./mvnw

      - name: Build and run tests with Maven
        run: ./mvnw test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: ${{ (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')) || github.event_name == 'workflow_dispatch' }}
          tags: europe-central2-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ecommerce-images/ecommerce-app:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Cloud Run
    needs: build
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # DEBUG START
      - name: 'Debug: Print GitHub OIDC Subject'
        run: |
          echo "--- GitHub Actions Context ---"
          echo "Repo: ${{ github.repository }}"
          echo "Ref:  ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"
          echo "--------------------------------"
          echo "Expected OIDC Subject String:"
          echo "repo:${{ github.repository }}:ref:${{ github.ref }}"
          echo "--------------------------------"
      # DEBUG END

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Run
        env:
          SERVICE_NAME: ${{ secrets.CLOUD_RUN_SERVICE_NAME }}
          IMAGE_URL: europe-central2-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ecommerce-images/ecommerce-app:${{ github.sha }}
          REGION: ${{ secrets.CLOUD_RUN_REGION }}
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SQL_INSTANCE: ${{ secrets.CLOUD_SQL_INSTANCE_CONNECTION_NAME }}

          DB_NAME: ${{ secrets.DB_NAME }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_IP: ${{ secrets.DB_IP }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MAIL_USER: ${{ secrets.SPRING_MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          REMEMBER_ME_KEY: ${{ secrets.REMEMBER_ME_KEY }}

        run: |
          gcloud run deploy "$SERVICE_NAME" \
            --image "$IMAGE_URL" \
            --region "$REGION" \
            --platform managed \
            --allow-unauthenticated \
            --project "$PROJECT_ID" \
            --add-cloudsql-instances "$SQL_INSTANCE" \
            --set-env-vars="SPRING_PROFILES_ACTIVE=prod" \
            --set-env-vars="SPRING_JPA_HIBERNATE_DDL_AUTO=validate" \
            --set-env-vars="SPRING_DATASOURCE_URL=jdbc:mysql://$DB_IP:3306/$DB_NAME?createDatabaseIfNotExist=false" \
            --set-env-vars="SPRING_DATASOURCE_PROPERTIES_socketFactory=com.google.cloud.sql.mysql.SocketFactory" \
            --set-env-vars="SPRING_DATASOURCE_PROPERTIES_cloudSqlInstance=$SQL_INSTANCE" \
            --set-env-vars="SPRING_DATASOURCE_USERNAME=$DB_USER" \
            --set-env-vars="SPRING_DATASOURCE_PASSWORD=$DB_PASSWORD" \
            --set-env-vars="SPRING_MAIL_USERNAME=$MAIL_USER" \
            --set-env-vars="SPRING_MAIL_PASSWORD=$MAIL_PASSWORD" \
            --set-env-vars="APP_BASE_URL=$APP_BASE_URL" \
            --set-env-vars="SPRING_SESSION_STORE_TYPE=jdbc" \
            --set-env-vars="SPRING_SESSION_JDBC_INITIALIZE_SCHEMA=always" \
            --set-env-vars="SERVER_FORWARD_HEADERS_STRATEGY=NATIVE" \
            --set-env-vars="SERVER_SERVLET_SESSION_COOKIE_NAME=__session" \
            --set-env-vars="REMEMBER_ME_KEY=$REMEMBER_ME_KEY" \
            --quiet
